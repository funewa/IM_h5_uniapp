import{u as t,s as e,_ as s,a,r as n,b as l,o as i,c as o,w as c,n as u,d as r,e as d,f as m,g,h as f,i as p,t as h,F as _,j as C,k as b,l as k,m as y,$ as T,p as x,q as I,v,x as w,y as S,z as P,A as j,B as N}from"./index.5cd51b9e.js";import{e as L,_ as A}from"./emoji.41844c8b.js";import{r as B}from"./uni-app.es.df83c1db.js";import{s as $}from"./status.8d414f26.js";import M from"./pages-contacts-index.ef2f71a7.js";import{s as D}from"./scan.ee64dc7e.js";const W=t(e);var E=s({name:"message-list",props:{msgs:{type:Array,default:function(){return[]}},btnWidth:{type:Number,default:320}},components:{statusPoint:$},data:()=>({msgsIn:[],damping:.29,moveIndex:-1,x:0,oX:0,scY:!0,btnWidthpx:160,touchStart:!1,modalName:null,listTouchStart:0,listTouchDirection:null,emojiMap:[],chatStatus:!0,paddingB:0,appSetting:W.appSetting,globalConfig:W.globalConfig}),created:function(){this.init(this.msgs),this.btnWidthpx=-1*a(this.btnWidth)+2;let t=[];L.forEach((function(e){let s=e.children;s.length>0&&s.forEach((function(e){let s=e.name,a=e.src;t[s]=a}))})),this.emojiMap=t,this.paddingB=this.inlineTools},watch:{msgs:function(t){this.init(t)}},methods:{init:function(t){this.moveIndex=-1,this.msgsIn=t.filter((t=>t.lastContent))},scrolltolower:function(){},emojiToHtml(t){if(!t)return;let e=this.emojiMap;return t.replace(/\[!(\w+)\]/gi,(function(t,s){var a=s;return e[a]?'<img class=\'mr-5\' style="width:18px;height:18px" emoji-name="'.concat(s,'" src="').concat(e[a],'" />'):"[!".concat(s,"]")}))},ListTouchStart(t){this.listTouchStart=t.touches[0].pageX},ListTouchMove(t){let e=t.touches[0].pageX-this.listTouchStart;Math.abs(e)>100&&e<0?this.listTouchDirection="left":this.listTouchDirection="right"},ListTouchEnd(t){"left"==this.listTouchDirection?(this.modalName=t.currentTarget.dataset.target,this.chatStatus=!1):this.modalName=null,this.listTouchDirection=null},openChat(t,e){this.chatStatus?this.$emit("itemTap",t,e):this.chatStatus=!0},from_time(t){return this.$util.timeFormat(t)},btnTap(t,e){this.$emit("btnTap",t,e)}}},[["render",function(t,e,s,a,k,y){const T=C,x=n("Tags"),I=n("statusPoint"),v=b,w=B(l("mp-html"),A),S=n("Empty");return i(),o(T,{class:"im-message-list"},{default:c((()=>[k.msgsIn.length>0?(i(),o(T,{key:0,class:"cu-list menu-avatar",style:u({paddingBottom:k.paddingB+"px"})},{default:c((()=>[(i(!0),r(_,null,d(k.msgsIn,((t,e)=>(i(),o(T,{class:m(["cu-item",[k.modalName=="move-box-"+e?"move-cur":"",1==t.is_top?"top-contacts":"",0==t.is_group?"third":"second"]]),key:e,onTouchstart:y.ListTouchStart,onTouchmove:y.ListTouchMove,onTouchend:y.ListTouchEnd,onClick:s=>y.openChat(e,t),"data-target":"move-box-"+e},{default:c((()=>[g(T,{class:m(["cu-avatar lg",k.appSetting.circleAvatar?"round":"radius"]),style:u([{backgroundImage:"url("+t.avatar+")"}])},null,8,["class","style"]),g(T,{class:"content"},{default:c((()=>[g(T,{class:"c-333"},{default:c((()=>[1==t.is_group?(i(),o(x,{key:0,text:"群聊",size:"mini"})):f("",!0),t.is_online&&0==t.is_group&&1==k.globalConfig.chatInfo.online?(i(),o(I,{key:1,type:"success"})):f("",!0),g(T,{class:"text-overflow f-16",style:{width:"80%"}},{default:c((()=>[p(h(t.displayName),1)])),_:2},1024)])),_:2},1024),g(T,{class:"im-flex im-justify-content-start im-align-items-start pt-5",style:{height:"50rpx",overflow:"hidden"}},{default:c((()=>[g(T,{class:"text-gray text-sm"},{default:c((()=>[t.unread>0&&0==t.is_notice?(i(),o(v,{key:0},{default:c((()=>[p("["+h(t.unread)+"条未读] ",1)])),_:2},1024)):f("",!0)])),_:2},1024),g(w,{content:y.emojiToHtml(t.lastContent),class:"im-flex text-gray text-sm text-overflow no-click"},null,8,["content"])])),_:2},1024)])),_:2},1024),g(T,{class:"action"},{default:c((()=>[g(T,{class:"text-grey text-xs"},{default:c((()=>[p(h(y.from_time(t.lastSendTime)),1)])),_:2},1024),t.unread>0&&t.is_notice?(i(),o(T,{key:0,class:"cu-tag round bg-red sm"},{default:c((()=>[p(h(t.unread),1)])),_:2},1024)):f("",!0),0==t.is_notice?(i(),o(T,{key:1,class:"c-999"},{default:c((()=>[g(v,{class:"cuIcon-musicforbidfill"})])),_:1})):f("",!0)])),_:2},1024),g(T,{class:m(["move",0==t.is_group?"third":"second"])},{default:c((()=>[1==t.is_top?(i(),o(T,{key:0,class:"bg-grey",onClick:e=>y.btnTap(0,t)},{default:c((()=>[p("取消置顶")])),_:2},1032,["onClick"])):(i(),o(T,{key:1,class:"bg-blue",onClick:e=>y.btnTap(0,t)},{default:c((()=>[p("置顶聊天")])),_:2},1032,["onClick"])),1==t.is_notice?(i(),o(T,{key:2,class:"bg-orange",onClick:e=>y.btnTap(2,t)},{default:c((()=>[p("免扰")])),_:2},1032,["onClick"])):(i(),o(T,{key:3,class:"bg-orange",onClick:e=>y.btnTap(2,t)},{default:c((()=>[p("取消免扰")])),_:2},1032,["onClick"])),0==t.is_group?(i(),o(T,{key:4,class:"bg-red",onClick:e=>y.btnTap(1,t)},{default:c((()=>[p("删除会话")])),_:2},1032,["onClick"])):f("",!0)])),_:2},1032,["class"])])),_:2},1032,["class","onTouchstart","onTouchmove","onTouchend","onClick","data-target"])))),128))])),_:1},8,["style"])):(i(),o(S,{key:1,noDatatext:"暂无聊天",textcolor:"#999"}))])),_:1})}],["__scopeId","data-v-86598c00"]]);const F=k(e),{contacts:H}=y(F),Q=t(e),{multiport:X}=y(Q);var q=s({components:{messageList:E},data:()=>({navCurrent:0,msgs:H,mainHeight:500,pageLoading:!0,multiport:X,socketStatus:!0}),mounted(){T("socketStatus",(t=>{t||(this.multiport=!1),this.socketStatus=t}))},methods:{btnTap:function(t,e){0==t?(e.is_top=0==e.is_top?1:0,this.$api.msgApi.setChatTopAPI({id:e.id,is_top:e.is_top,is_group:e.is_group}).then((t=>{0==t.code&&F.updateContacts(e)}))):1==t?x({title:"确定要删除吗?",success:t=>{t.confirm&&this.$api.msgApi.delChatAPI({id:e.id,is_group:e.is_group}).then((t=>{0==t.code&&F.deleteContacts(e)}))}}):2==t&&(e.is_notice=0==e.is_notice?1:0,this.$api.msgApi.setIsNotice({id:e.id,is_notice:e.is_notice,is_group:e.is_group}).then((t=>{0==t.code&&F.updateContacts(e)})))},itemTap:function(t,e){F.unread-=e.unread;let s=this.msgs;s[t].unread=0,F.initContacts(s),I({url:"/pages/message/chat?id="+e.id})},reconnect(){v({title:"重连中..."}),this.socketIo.connectSocketInit({type:"ping"}),setTimeout((()=>{w()}),1500)}}},[["render",function(t,e,s,a,l,u){const r=C,d=n("messageList");return i(),o(r,null,{default:c((()=>[l.socketStatus?f("",!0):(i(),o(r,{key:0,class:"socket-status pd-10 im-flex justify-between im-align-items-center"},{default:c((()=>[g(r,{class:"cuIcon-infofill text-red f-18"}),g(r,{class:"c-666 f-12"},{default:c((()=>[p(" WS通信已断开，检查网络设置是否正常")])),_:1}),g(r,{onClick:e[0]||(e[0]=t=>u.reconnect())},{default:c((()=>[p("重连")])),_:1})])),_:1})),l.multiport?(i(),o(r,{key:1,class:"border-b pd-10 text-gray im-flex im-justify-content-start"},{default:c((()=>[g(r,{class:"iconfont icon-web f-18 ml-20"}),g(r,{class:"f-12 ml-20"},{default:c((()=>[p(" Web网页端已登录")])),_:1})])),_:1})):f("",!0),g(d,{msgs:l.msgs,onItemTap:u.itemTap,onBtnTap:u.btnTap},null,8,["msgs","onItemTap","onBtnTap"])])),_:1})}],["__scopeId","data-v-7210d8d8"]]);const z=t();var G=s({data:()=>({isCard:!0,userInfo:z.userInfo,paddingB:0,current:0,list:[],total:0,params:{page:1,limit:10,is_mine:0}}),created:function(){this.paddingB=this.inlineTools,this.getList()},methods:{IsCard(t){this.isCard=t.detail.value},getList(){this.$api.third_openApi.thirdList(this.params).then((t=>{0==t.code&&(this.list=t.data.data,this.total=t.count)}))},To_third(t,e){var s=S("userInfo");I(1==t?{url:"/pages/nearby/nearby"}:2==t?{url:"/pages/opengroup/opengroup"}:{url:"/pages/third/third?url="+e.url+"&uid="+s.account})}}},[["render",function(t,e,s,a,n,l){const f=C,k=b,y=P;return i(),o(f,{style:u({paddingBottom:n.paddingB+"px"})},{default:c((()=>[g(f,{style:{"padding-bottom":"30rpx"}},{default:c((()=>[g(f,{class:"cu-list menu mt-10"},{default:c((()=>[g(f,{class:"cu-item arrow",onClick:e[0]||(e[0]=t=>l.To_third(1,""))},{default:c((()=>[g(f,{class:m(["cu-avatar mr-15 invite-bg","round"])}),g(f,{class:"content"},{default:c((()=>[g(k,{class:"c-333"},{default:c((()=>[p("附近的人")])),_:1})])),_:1})])),_:1}),g(f,{class:"cu-item arrow",onClick:e[1]||(e[1]=t=>l.To_third(2,""))},{default:c((()=>[g(f,{class:m(["cu-avatar mr-15 group-bg","round"])}),g(f,{class:"content"},{default:c((()=>[g(k,{class:"c-333"},{default:c((()=>[p("公开的群")])),_:1})])),_:1})])),_:1}),(i(!0),r(_,null,d(n.list,((t,e)=>(i(),o(f,{class:"cu-item arrow",key:e,onClick:e=>l.To_third(3,t)},{default:c((()=>[g(f,{class:m(["cu-avatar mr-15","round"])},{default:c((()=>[g(y,{src:t.logo,mode:"widthFix",style:{width:"100%"}},null,8,["src"])])),_:2},1024),g(f,{class:"content"},{default:c((()=>[g(k,{class:"c-333"},{default:c((()=>[p(h(t.name),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})])),_:1},8,["style"])}],["__scopeId","data-v-508c67b4"]]);const U=t(e);var Y=s({data:()=>({loginStore:U,globalConfig:U.globalConfig,appSetting:U.appSetting}),onShow(){},methods:{logout(){let t=S("client_id");this.$api.LoginApi.logout({client_id:t}).then((t=>{0==t.code&&U.logout()}))},about(){if(this.globalConfig&&this.globalConfig.demon_mode){I({url:"/pages/mine/webview?src="+"https://im.raingad.com"})}else I({url:"/pages/mine/about"})},showSetting(){I({url:"/pages/mine/setting"})},showsecure(){I({url:"/pages/mine/secure"})},editInfo(){I({url:"/pages/mine/profile"})},scan(){D.scanQr()},openQr(){I({url:"/pages/index/qrcode"})}}},[["render",function(t,e,s,a,n,l){const r=C,d=b,f=j;return i(),o(r,null,{default:c((()=>[g(r,{class:"padding flex im-space-between im-align-items-center bg-white mb-10"},{default:c((()=>[g(r,{class:"flex justify-start bg-white",onClick:e[0]||(e[0]=t=>l.editInfo())},{default:c((()=>[g(r,{class:m(["cu-avatar lg mr-15",n.appSetting.circleAvatar?"round":"radius"]),style:u([{backgroundImage:"url("+n.loginStore.userInfo.avatar+")"}])},null,8,["class","style"]),g(r,{class:"im-flex im-justify-content-start im-columns"},{default:c((()=>[g(r,{class:"mb-5 f-18 mb-10 im-flex im-align-items-center"},{default:c((()=>[g(r,{class:"c-333"},{default:c((()=>[p(h(n.loginStore.userInfo.realname),1)])),_:1})])),_:1}),g(r,{class:"text-gray mb-10"},{default:c((()=>[p(h(n.loginStore.userInfo.account),1)])),_:1})])),_:1})])),_:1})])),_:1}),g(r,{class:"cu-list menu"},{default:c((()=>[g(r,{class:"cu-item",onClick:l.scan},{default:c((()=>[g(r,{class:"content"},{default:c((()=>[g(d,{class:"cuIcon-scan text-blue"}),g(d,null,{default:c((()=>[p("扫一扫")])),_:1})])),_:1}),g(r,{class:"action"},{default:c((()=>[g(d,{class:"text-grey cuIcon-right"})])),_:1})])),_:1},8,["onClick"]),g(r,{class:"cu-item",onClick:l.showSetting},{default:c((()=>[g(r,{class:"content"},{default:c((()=>[g(d,{class:"cuIcon-settings text-grey"}),g(d,null,{default:c((()=>[p("通用设置")])),_:1})])),_:1}),g(r,{class:"action"},{default:c((()=>[g(d,{class:"text-grey cuIcon-right"})])),_:1})])),_:1},8,["onClick"]),g(r,{class:"cu-item",onClick:l.showsecure},{default:c((()=>[g(r,{class:"content"},{default:c((()=>[g(d,{class:"cuIcon-safe text-orange"}),g(d,null,{default:c((()=>[p("账号安全")])),_:1})])),_:1}),g(r,{class:"action"},{default:c((()=>[g(d,{class:"text-grey cuIcon-right"})])),_:1})])),_:1},8,["onClick"])])),_:1}),g(r,{class:"padding flex flex-direction"},{default:c((()=>[g(f,{class:"cu-btn bg-red lg",onClick:e[1]||(e[1]=t=>l.logout())},{default:c((()=>[p("退出登录")])),_:1})])),_:1})])),_:1})}]]);const J=k(e),K=t(e),{unread:O,sysUnread:R}=y(J);var V=s({components:{message:q,contacts:M,compass:G,mine:Y},data(){let t=[{name:"message",title:"消息",notice:O},{name:"contacts",title:"通讯录",notice:R},{name:"compass",title:"探索",notice:0}];return t.push({name:"mine",title:"我的",notice:0}),{globalConfig:K.globalConfig,PageCur:"message",PageName:"消息",TabCur:0,modelName:!1,navList:t,userinfo:{}}},onShow(){},mounted(){N(),S("allContacts").length||this.initContacts(),T("socketStatus",(t=>{t&&this.initContacts()})),this.userinfo=S("userInfo")},methods:{closeModel(){this.modelName=!1},scan(){D.scanQr()},NavChange:function(t){this.PageCur=t.name,this.PageName=t.title},showContacts(){1==this.TabCur?this.TabCur=0:this.TabCur=1},initContacts(){this.modelName="",this.$api.msgApi.initContacts().then((t=>{J.sysUnread=t.count,J.initContacts(t.data)}))},addGroup(){I({url:"/pages/index/userSelection?type=1"})},addFriend(){I({url:"/pages/contacts/search"})},search(){const t="message"==this.PageCur?1:2;I({url:"/pages/index/search?type="+t})}}},[["render",function(t,e,s,a,l,u){const k=b,y=C,T=n("cu-custom"),x=n("message"),I=n("contacts"),v=n("compass"),w=n("mine"),S=P;return i(),o(y,null,{default:c((()=>[g(T,{bgColor:"bg-white"},{backText:c((()=>["message"==l.PageCur||"contacts"==l.PageCur?(i(),o(y,{key:0,class:"f-20 ml-10 mr-10",onClick:e[0]||(e[0]=t=>u.search())},{default:c((()=>[g(k,{class:"cuIcon-search",style:{"margin-left":"-10px"}})])),_:1})):f("",!0)])),content:c((()=>[p(h(l.PageName),1)])),right:c((()=>["contacts"==l.PageCur&&l.globalConfig&&l.globalConfig.demon_mode?(i(),o(y,{key:0,class:"f-20 ml-10 mr-10",onClick:e[1]||(e[1]=t=>u.showContacts())},{default:c((()=>[g(k,{class:m(["f-24",l.TabCur?"cuIcon-peoplelist":"cuIcon-friend"])},null,8,["class"])])),_:1})):f("",!0),"message"==l.PageCur?(i(),o(y,{key:1,class:"f-20 ml-10 mr-10",onClick:e[2]||(e[2]=t=>l.modelName="add")},{default:c((()=>[g(k,{class:"cuIcon-add f-28"})])),_:1})):f("",!0)])),_:1}),g(y,null,{default:c((()=>["message"==l.PageCur?(i(),o(x,{key:0})):f("",!0),"contacts"==l.PageCur?(i(),o(I,{key:1,TabCur:l.TabCur},null,8,["TabCur"])):f("",!0),"compass"==l.PageCur?(i(),o(v,{key:2})):f("",!0),"mine"==l.PageCur?(i(),o(w,{key:3})):f("",!0)])),_:1}),g(y,{class:"cu-bar tabbar bg-white shadow foot"},{default:c((()=>[(i(!0),r(_,null,d(l.navList,((t,e)=>(i(),o(y,{class:"action",onClick:e=>u.NavChange(t),key:e,"data-cur":"message"},{default:c((()=>[g(y,{class:"cuIcon-cu-image"},{default:c((()=>[g(S,{src:"/static/image/tabbar/"+[t.name]+[l.PageCur==t.name?"-active":""]+".svg"},null,8,["src"]),t.notice>0?(i(),o(y,{key:0,class:"cu-tag badge"},{default:c((()=>[p(h(t.notice),1)])),_:2},1024)):f("",!0)])),_:2},1024),g(y,{class:m(l.PageCur==t.name?"text-green":"text-black")},{default:c((()=>[p(h(t.title),1)])),_:2},1032,["class"])])),_:2},1032,["onClick"])))),128))])),_:1}),g(y,{class:m(["cu-modal bottom-modal","add"==l.modelName?"show":""]),onClick:e[8]||(e[8]=t=>l.modelName="")},{default:c((()=>[g(y,{class:"cu-dialog"},{default:c((()=>[g(y,{class:"manage-content"},{default:c((()=>[g(y,{class:"cu-list menu bg-white"},{default:c((()=>[g(y,{class:"cu-item",onClick:e[3]||(e[3]=t=>{u.initContacts()})},{default:c((()=>[g(y,{class:"content padding-tb-sm"},{default:c((()=>[g(k,{class:"cuIcon-refresh"}),g(k,null,{default:c((()=>[p("更新消息列表")])),_:1})])),_:1})])),_:1}),void 0!==l.userinfo.role&&1==l.userinfo.role?(i(),o(y,{key:0},{default:c((()=>[2==l.globalConfig.sysInfo.runMode?(i(),o(y,{key:0,class:"cu-item",onClick:e[4]||(e[4]=t=>u.addFriend())},{default:c((()=>[g(y,{class:"content padding-tb-sm"},{default:c((()=>[g(k,{class:"cuIcon-friendadd"}),g(k,null,{default:c((()=>[p("添加朋友")])),_:1})])),_:1})])),_:1})):f("",!0),g(y,{class:"cu-item",onClick:e[5]||(e[5]=t=>u.addGroup())},{default:c((()=>[g(y,{class:"content padding-tb-sm"},{default:c((()=>[g(k,{class:"cuIcon-friend"}),g(k,null,{default:c((()=>[p("创建群聊")])),_:1})])),_:1})])),_:1}),g(y,{class:"cu-item",onClick:e[6]||(e[6]=t=>u.scan())},{default:c((()=>[g(y,{class:"content padding-tb-sm"},{default:c((()=>[g(k,{class:"cuIcon-scan mr-10"}),g(k,null,{default:c((()=>[p("扫 一 扫")])),_:1})])),_:1})])),_:1})])),_:1})):f("",!0),g(y,{class:"parting-line-5"}),g(y,{class:"cu-item",onClick:e[7]||(e[7]=t=>l.modelName="")},{default:c((()=>[g(y,{class:"content padding-tb-sm"},{default:c((()=>[g(k,{class:"c-red"},{default:c((()=>[p("取消")])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["class"])])),_:1})}]]);export{V as default};
